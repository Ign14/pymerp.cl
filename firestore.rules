rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN';
    }
    
    function isEntrepreneur() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ENTREPRENEUR';
    }
    
    function belongsToUserCompany(companyId) {
      return isAuthenticated() &&
             companyId != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id == companyId;
    }

    function getServiceCompanyId(serviceId) {
      return get(/databases/$(database)/documents/services/$(serviceId)).data.company_id;
    }
    
    // ==================== USERS ====================
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isSuperAdmin();
    }
    
    // ==================== PLATFORM CONFIG (SUPERADMIN) ====================
    match /platform_config/{configId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }

    // ==================== ACCESS REQUESTS ====================
    match /accessRequests/{requestId} {
      allow read: if isSuperAdmin();
      allow create: if true; // Public can create requests
      allow update, delete: if isSuperAdmin();
    }

    // ==================== DATA DELETION REQUESTS ====================
    match /data_deletion_requests/{requestId} {
      allow read: if isAuthenticated() &&
        (request.auth.uid == resource.data.user_id || isSuperAdmin());
      allow create, update, delete: if isSuperAdmin();
    }
    
    // ==================== COMPANIES ====================
    match /companies/{companyId} {
      allow read: if true; // Public read for public pages (e.g. /micarritodecomida)
      allow create: if isAuthenticated();
      allow update: if belongsToUserCompany(companyId) || isSuperAdmin();
      allow delete: if isSuperAdmin();
    }
    
    // ==================== COMPANIES PUBLIC ====================
    // Colección pública con datos whitelisted para búsquedas y mapas
    // Solo lectura pública permitida. Escritura desde cliente muy limitada.
    match /companies_public/{companyId} {
      allow read: if true; // Lectura pública permitida
      // Permitir solo updates muy acotados por el dueño de la empresa.
      // Esto habilita la configuración de mesas del Menú QR.
      allow update: if isAuthenticated() &&
                     belongsToUserCompany(companyId) &&
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                       'menu_qr_table_count',
                       'updated_at'
                     ]);
      allow create, delete: if false;
    }
    
    // ==================== COMPANY APPEARANCE ====================
    match /companyAppearances/{appearanceId} {
      allow read: if true; // Public read
      allow write: if isAuthenticated() &&
                     belongsToUserCompany(
                       request.resource.data.company_id != null
                         ? request.resource.data.company_id
                         : resource.data.company_id
                     );
    }
    
    // ==================== SERVICES ====================
    match /services/{serviceId} {
      allow read: if true; // Public read for booking
      allow create: if isEntrepreneur() && 
                      belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && 
                              belongsToUserCompany(resource.data.company_id);
    }
    
    // ==================== PRODUCTS ====================
    match /products/{productId} {
      allow read: if true; // Public read for catalog
      allow create: if isEntrepreneur() && 
                      belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && 
                              belongsToUserCompany(resource.data.company_id);
    }

    // ==================== MINIMARKET ACCESS ACCOUNTS ====================
    // Cuentas de acceso a la app Minimarket (operadores). Dashboard escribe; app minimarket lee para login.
    match /minimarket_access_accounts/{accountId} {
      // En producción, bloquear lectura pública. El módulo minimarket está en desarrollo.
      allow read: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
      allow create: if isEntrepreneur() && request.resource.data.get('company_id', '') != '' &&
                      belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && resource.data.company_id != null &&
                      belongsToUserCompany(resource.data.company_id);
    }
    
    // ==================== PROFESSIONALS ====================
    match /professionals/{professionalId} {
      allow read: if true; // Public read for booking
      allow create: if isEntrepreneur() && 
                      (belongsToUserCompany(request.resource.data.company_id) || isSuperAdmin());
                      // Note: Subscription limit validated in Cloud Function
      allow update: if isEntrepreneur() && 
                      (belongsToUserCompany(resource.data.company_id) || isSuperAdmin());
      allow delete: if isEntrepreneur() && 
                      (belongsToUserCompany(resource.data.company_id) || isSuperAdmin());
    }
    
    // ==================== PROFESSIONAL AVAILABILITY ====================
    match /professional_availability/{availabilityId} {
      allow read: if true; // Public read for booking
      allow create: if isEntrepreneur() && 
                     belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && 
                              belongsToUserCompany(resource.data.company_id);
    }
    
    // Helper: Check if user is company owner
    function isCompanyOwner(companyId) {
      return isAuthenticated() &&
             companyId != null &&
             exists(/databases/$(database)/documents/companies/$(companyId)) &&
             get(/databases/$(database)/documents/companies/$(companyId)).data.owner_user_id == request.auth.uid;
    }
    
    // ==================== APPOINTMENTS ====================
    match /appointments/{appointmentId} {
      // Read: user must belong to the company, be company owner, or be super admin
      allow read: if isAuthenticated() && (
        resource.data.company_id != null && 
        (
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id == resource.data.company_id) ||
          isCompanyOwner(resource.data.company_id) ||
          isSuperAdmin()
        )
      );
      // Create: user must belong to the company, be company owner, or be super admin
      allow create: if isAuthenticated() && (
        request.resource.data.company_id != null &&
        (
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id == request.resource.data.company_id) ||
          isCompanyOwner(request.resource.data.company_id) ||
          isSuperAdmin()
        )
      );
      // Update/Delete: user must belong to the company, be company owner, or be super admin
      allow update, delete: if isAuthenticated() && (
        resource.data.company_id != null &&
        (
          (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id == resource.data.company_id) ||
          isCompanyOwner(resource.data.company_id) ||
          isSuperAdmin()
        )
      );
    }
    
    // ==================== APPOINTMENT REQUESTS (Legacy) ====================
    match /appointmentRequests/{requestId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if true; // Public can create requests
      allow update, delete: if isEntrepreneur() && 
                              belongsToUserCompany(resource.data.company_id);
    }
    
    // ==================== PRODUCT ORDER REQUESTS ====================
    // Read: público por ID (página /tracking). Quien tiene el link puede ver el estado.
    // Create: público (pedidos desde sitio/menú). Update/Delete: solo empresa.
    match /productOrderRequests/{orderId} {
      allow read: if true; // Public read by document ID - tracking link is secret
      allow create: if true; // Public can create orders
      allow update, delete: if isEntrepreneur() && 
                              belongsToUserCompany(resource.data.company_id);
    }
    
    // ==================== NOTIFICATION SETTINGS ====================
    match /notification_settings/{settingId} {
      allow read: if isAuthenticated() &&
        request.auth.uid == resource.data.user_id &&
        (belongsToUserCompany(resource.data.company_id) || isSuperAdmin());
      
      allow create: if isAuthenticated() &&
        request.auth.uid == request.resource.data.user_id &&
        (belongsToUserCompany(request.resource.data.company_id) || isSuperAdmin());
      
      allow update, delete: if isAuthenticated() &&
        request.auth.uid == resource.data.user_id &&
        (belongsToUserCompany(resource.data.company_id) || isSuperAdmin());
    }
    
    // ==================== SCHEDULE SLOTS ====================
    match /scheduleSlots/{slotId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated() && (belongsToUserCompany(request.resource.data.company_id) || isSuperAdmin());
      allow update, delete: if isAuthenticated() && (belongsToUserCompany(resource.data.company_id) || isSuperAdmin());
    }
    
    // ==================== SERVICE SCHEDULES ====================
    match /serviceSchedules/{scheduleId} {
      allow read: if true; // Public read
      allow create: if isAuthenticated() &&
        (belongsToUserCompany(
          request.resource.data.company_id != null
            ? request.resource.data.company_id
            : getServiceCompanyId(request.resource.data.service_id)
        ) || isSuperAdmin());
      allow update, delete: if isAuthenticated() &&
        (belongsToUserCompany(
          resource.data.company_id != null
            ? resource.data.company_id
            : getServiceCompanyId(resource.data.service_id)
        ) || isSuperAdmin());
    }

    // ==================== DELIVERY ROUTES ====================
    match /delivery_routes/{routeId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }

    // ==================== PAYMENT COLLECTIONS ====================
    match /payment_collections/{collectionId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }

    // ==================== DELIVERY LOCATIONS ====================
    match /delivery_locations/{locationId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }
    
    // ==================== PUBLIC PAGE EVENTS ====================
    match /publicPageEvents/{eventId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if true; // Public can create events (analytics)
      allow update, delete: if isSuperAdmin();
    }

    // ==================== MENU CATEGORIES ====================
    match /menu_categories/{categoryId} {
      allow read: if true; // Public menu
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }

    // ==================== CLINIC RESOURCES ====================
    match /clinic_resources/{resourceId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }

    // ==================== EVENTS ====================
    match /events/{eventId} {
      allow read: if true; // Public events
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }

    // ==================== EVENT RESERVATIONS ====================
    match /event_reservations/{reservationId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }

    // ==================== PROPERTIES ====================
    match /properties/{propertyId} {
      allow read: if true; // Public listings
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }

    // ==================== PROPERTY BOOKINGS ====================
    match /property_bookings/{bookingId} {
      allow read: if isAuthenticated() && belongsToUserCompany(resource.data.company_id);
      allow create: if isEntrepreneur() && belongsToUserCompany(request.resource.data.company_id);
      allow update, delete: if isEntrepreneur() && belongsToUserCompany(resource.data.company_id);
    }
    
    // ==================== CALENDAR INVENTORY ====================
    match /calendarInventory/{inventoryId} {
      // Public read for booking availability (only status BOOKED/REQUESTED, no sensitive data)
      allow read: if true; // Public read for booking calendar
      allow create, update, delete: if isAuthenticated() && (belongsToUserCompany(request.resource.data.company_id) || isSuperAdmin());
    }

    // ==================== PUBLIC COMPANIES ====================
    match /public_companies/{companyId} {
      // Solo lectura pública - datos sincronizados desde companies
      allow read: if true; // Datos públicos accesibles para todos
      allow write: if false; // Solo se actualiza via Cloud Functions
    }

    // ==================== CONTACT MESSAGES ====================
    match /contact_messages/{messageId} {
      allow read: if isAuthenticated() && (isSuperAdmin() || belongsToUserCompany(resource.data.company_id));
      allow create: if true; // Cualquiera puede enviar mensajes de contacto
      allow update: if isAuthenticated() && (isSuperAdmin() || belongsToUserCompany(resource.data.company_id));
      allow delete: if isSuperAdmin();
    }

    // ==================== APPOINTMENT LOCKS ====================
    match /appointment_locks/{lockId} {
      // Locks temporales para prevenir double-booking
      allow read: if true; // Necesario para verificar disponibilidad
      allow write: if false; // Solo se gestiona via Cloud Functions
    }

    // Alias para locks (si se usa el nombre corto)
    match /locks/{lockId} {
      allow read: if true;
      allow write: if false; // Solo via Cloud Functions
    }
    
    // ==================== DEFAULT DENY ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
