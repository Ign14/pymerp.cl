rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN');
      allow write: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN');
    }

    // Access Requests - only superadmin can read/write
    match /accessRequests/{requestId} {
      allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN';
      allow create: if request.auth == null; // Anyone can create (public form)
    }

    // Companies
    match /companies/{companyId} {
      allow read: if true; // Public read for public pages
      allow write: if request.auth != null && (
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id == companyId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
    }

    // Company Appearances
    match /companyAppearances/{appearanceId} {
      allow read: if true; // Public read
      allow write: if request.auth != null && (
        resource.data.company_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
    }

    // Schedule Slots
    match /scheduleSlots/{slotId} {
      allow read: if true; // Public read
      allow write: if request.auth != null && (
        resource.data.company_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
    }

    // Services
    match /services/{serviceId} {
      allow read: if true; // Public read
      allow write: if request.auth != null && (
        resource.data.company_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
    }

    // Service Schedules
    match /serviceSchedules/{scheduleId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Products
    match /products/{productId} {
      allow read: if true; // Public read
      allow write: if request.auth != null && (
        resource.data.company_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
    }

    // Appointment Requests
    match /appointmentRequests/{requestId} {
      allow read: if request.auth != null && (
        resource.data.company_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
      allow create: if true; // Public can create
    }

    // Product Order Requests
    match /productOrderRequests/{requestId} {
      allow read: if request.auth != null && (
        resource.data.company_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
      allow create: if true; // Public can create
    }

    // Public Page Events
    match /publicPageEvents/{eventId} {
      allow read: if request.auth != null && (
        resource.data.company_id == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.company_id ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SUPERADMIN'
      );
      allow create: if true; // Public can create
    }
  }
}

