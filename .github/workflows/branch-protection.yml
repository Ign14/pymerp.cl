name: Enforce Branch Protection

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to protect'
        required: true
        default: 'main'
        type: string
      dry_run:
        description: 'Dry run (only show what would be applied)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: read

jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.BRANCH_PROTECTION_TOKEN }}" ]; then
            echo "âŒ BRANCH_PROTECTION_TOKEN is not set."
            echo "ðŸ“– See .github/SECRETS.md for setup instructions"
            exit 1
          fi
          echo "âœ… BRANCH_PROTECTION_TOKEN is configured"

      - name: Show current protection (if exists)
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
          script: |
            const branch = '${{ github.event.inputs.branch || 'main' }}';
            try {
              const protection = await github.rest.repos.getBranchProtection({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch
              });
              console.log('ðŸ“‹ Current protection rules:');
              console.log(JSON.stringify(protection.data, null, 2));
            } catch (error) {
              console.log('â„¹ï¸ No existing protection rules found');
            }

      - name: Apply branch protection rules
        if: github.event.inputs.dry_run != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BRANCH_PROTECTION_TOKEN }}
          script: |
            const branch = '${{ github.event.inputs.branch || 'main' }}';
            const requiredChecks = [
              'test (18.x)',
              'test (20.x)',
              'e2e (20.x, chromium)',
            ];

            console.log(`ðŸ”§ Applying protection rules to: ${branch}`);
            console.log(`ðŸ“‹ Required checks: ${requiredChecks.join(', ')}`);

            await github.rest.repos.updateBranchProtection({
              owner: context.repo.owner,
              repo: context.repo.repo,
              branch,
              required_status_checks: {
                strict: true,
                contexts: requiredChecks,
              },
              enforce_admins: false,
              required_pull_request_reviews: {
                required_approving_review_count: 1,
                require_code_owner_reviews: false,
                dismiss_stale_reviews: true,
                require_last_push_approval: false,
              },
              restrictions: null,
              required_linear_history: false,
              allow_force_pushes: false,
              allow_deletions: false,
              block_creations: false,
              required_conversation_resolution: true,
            });

            console.log(`âœ… Branch protection applied successfully to: ${branch}`);

      - name: Dry run summary
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "## ðŸ” Dry Run - Branch Protection Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branch: \`${{ github.event.inputs.branch || 'main' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Rules that would be applied:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Required status checks: \`test (18.x)\`, \`test (20.x)\`, \`e2e (20.x, chromium)\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Require 1 pull request review" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dismiss stale reviews on push" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Require conversation resolution" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Block force pushes" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Block branch deletion" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To apply these rules, run workflow without dry_run flag**" >> $GITHUB_STEP_SUMMARY

      - name: Success summary
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "## âœ… Branch Protection Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Protected Branch: \`${{ github.event.inputs.branch || 'main' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Active Rules:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Required CI checks before merge" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pull request reviews required (1 approval)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Stale reviews dismissed automatically" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Conversation resolution required" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Force pushes blocked" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Branch deletion blocked" >> $GITHUB_STEP_SUMMARY
